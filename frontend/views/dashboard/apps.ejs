<%- include("../parties/head", { title: "Apps" }) %>

    <style>
        .nav-active {
            color: #22c55e !important;
            font-weight: 600;
        }

        .nav-hover:hover {
            color: #22c55e;
        }
    </style>
    </head>

    <body class="bg-[#0d1117] text-gray-200">

        <!-- TOP NAV -->
        <%- include("../parties/nav.ejs",{title:activeSide}) %>

            <div class="flex w-full gap-6">

                <!-- SIDE NAV -->
                <%- include("../parties/dash-side-nav.ejs",{activeSide:activeSide}) %>

                    <!-- MAIN -->
                    <main class="flex-1 space-y-8">

                        <!-- HEADER -->
                        <div class="flex justify-between items-center mt-6">
                            <h1 class="text-3xl font-bold text-green-400">Apps</h1>

                            <a href="/dashboard/Apps/create" class="border border-green-500/40 text-green-400 tech-font px-4 py-1.5 rounded-md
            hover:bg-green-600/10 hover:border-green-400 transition-all">
                                + create_app
                            </a>
                        </div>

                        <!-- TABLE -->
                        <div class="bg-[#161b22] p-6 rounded-xl border border-gray-700 overflow-x-auto">
                            <table class="min-w-full text-left text-gray-100">
                                <thead class="bg-gray-800">
                                    <tr>
                                        <th class="p-4 font-semibold">App Name</th>
                                        <th class="p-4 font-semibold">Description</th>
                                        <th class="p-4 font-semibold">Secret</th>
                                        <th class="p-4 font-semibold">Status</th>
                                        <th class="p-4 font-semibold">Actions</th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <% apps.forEach(app=> { %>

                                        <tr class="border-b border-gray-700 hover:bg-gray-900 cursor-pointer" onclick="openViewModal(
                                <%= app.id %>,
                                '<%= app.app_name %>',
                                '<%= app.description %>',
                                '<%= app.secret %>',
                                <%= app.active %>
                            )">

                                            <td class="p-4 hover:text-green-400">
                                                <%= app.app_name %>
                                            </td>
                                            <td class="p-4">
                                                <%= app.description %>
                                            </td>
                                            <td class="p-4">**** **** ****</td>

                                            <td class="p-4">
                                                <% if (app.active) { %>
                                                    <span class="text-green-400 font-semibold">Active</span>
                                                    <% } else { %>
                                                        <span class="text-red-400 font-semibold">Removed</span>
                                                        <% } %>
                                            </td>

                                            <td class="p-4 flex gap-3">

                                                <% if (app.active) { %>

                                                    <!-- VIEW KEYS -->
                                                    <button
                                                        onclick="event.stopPropagation(); openUrlTokenModal(<%= app.id %>)"
                                                        class="border border-green-500 text-green-400 px-3 py-1 rounded hover:bg-green-900/20">
                                                        ./view_keys
                                                    </button>

                                                    <!-- CREATE ROLE -->
                                                    <form action="/dashboard/Roles/create" method="POST"
                                                        onClick="event.stopPropagation();">
                                                        <input type="hidden" name="app_id" value="<%= app.id %>">
                                                        <input type="hidden" name="app_name"
                                                            value="<%= app.app_name %>">
                                                        <button type="submit"
                                                            class="border border-green-500 text-green-400 px-3 py-1 rounded hover:bg-green-900/20">
                                                            ./create_role
                                                        </button>
                                                    </form>

                                                    <!-- DELETE -->
                                                    <form action="/dashboard/apps/delete/<%= app.id %>" method="POST"
                                                        onClick="event.stopPropagation();">
                                                        <button type="submit"
                                                            class="border border-red-500 text-red-400 px-3 py-1 rounded hover:bg-red-900/20">
                                                            ./delete
                                                        </button>
                                                    </form>

                                                    <% } else { %>
                                                        <span class="text-red-500 font-semibold">removed</span>
                                                        <% } %>

                                            </td>
                                        </tr>

                                        <% }) %>
                                </tbody>
                            </table>
                        </div>

                    </main>
            </div>


            <!-- ========================================================== -->
            <!--        VIEW APP MODAL (NOW WITH UPDATE POST FORM)          -->
            <!-- ========================================================== -->

            <div id="viewModal" class="fixed inset-0 bg-black/70 hidden z-50 flex justify-center items-center">
                <div class="bg-[#161b22] p-8 rounded-2xl border border-gray-700 w-full max-w-xl">

                    <h2 class="text-2xl font-semibold text-green-400 mb-6 tech-font">View App</h2>

                    <!-- form used by UPDATE button -->
                    <form id="updateForm" action="/dashboard/apps/update" method="POST" class="hidden">
                        <input type="hidden" name="app_id" id="upd_app_id">
                        <input type="hidden" name="appName" id="upd_appName">
                        <input type="hidden" name="description" id="upd_description">
                        <input type="hidden" name="secret" id="upd_secret">
                    </form>

                    <div class="space-y-4">

                        <div>
                            <label class="text-green-400 tech-font">App Name</label>
                            <input id="viewName" readonly
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                        </div>

                        <div>
                            <label class="text-green-400 tech-font">Description</label>
                            <textarea id="viewDesc" readonly
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2"></textarea>
                        </div>

                        <div>
                            <label class="text-green-400 tech-font">Secret</label>
                            <div class="flex items-center gap-2">
                                <input id="viewSecret" readonly type="password"
                                    class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                                <button onclick="toggleSecretView()" class="text-yellow-400">Show</button>
                            </div>
                        </div>

                        <div>
                            <label class="text-green-400 tech-font">Status</label>
                            <input id="viewStatus" readonly
                                class="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2">
                        </div>

                    </div>

                    <div class="flex justify-end gap-3 mt-6">

                        <!-- UPDATE BUTTON submits the POST form -->
                        <button onclick="submitUpdateForm()"
                            class="border border-green-500 text-green-400 px-4 py-2 rounded hover:bg-green-900/20">
                            ./update
                        </button>

                        <button onclick="closeViewModal()"
                            class="border border-gray-500 text-gray-300 px-4 py-2 rounded hover:bg-gray-700">
                            ./close
                        </button>
                    </div>

                </div>
            </div>


            <!-- ========================================================== -->
            <!--                    URL TOKEN MODAL                         -->
            <!-- ========================================================== -->

            <div id="urlTokenModal" class="fixed inset-0 bg-black/70 flex justify-center items-center hidden z-50">

                <div class="bg-[#161b22] p-8 rounded-2xl border border-gray-700 w-full max-w-lg shadow-xl">

                    <h2 class="text-2xl font-semibold text-green-400 mb-6 tech-font">Integration Keys</h2>

                    <div class="space-y-6">

                        <div>
                            <label class="block text-green-400 mb-1 tech-font">API URL</label>
                            <div class="flex items-center bg-gray-800 border border-gray-700 rounded px-2">
                                <input id="apiUrl" readonly class="w-full bg-transparent px-2 py-2 text-gray-100">
                                <button class="text-blue-400 px-2" onclick="copyToClipboard('apiUrl')">Copy</button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-green-400 mb-1 tech-font">Client Token</label>
                            <div class="flex items-center bg-gray-800 border border-gray-700 rounded px-2">
                                <input id="clientToken" readonly type="password"
                                    class="w-full bg-transparent px-2 py-2 text-gray-100">
                                <button onclick="toggleToken()" class="text-yellow-400 px-2">Show</button>
                                <button onclick="copyToClipboard('clientToken')"
                                    class="text-blue-400 px-2">Copy</button>
                            </div>
                        </div>

                    </div>

                    <div class="flex justify-end mt-6">
                        <button onclick="closeUrlTokenModal()"
                            class="border border-gray-500 text-gray-300 px-4 py-2 rounded hover:bg-gray-700">
                            ./close
                        </button>
                    </div>
                </div>
            </div>


            <!-- TOAST -->
            <div id="copyToast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-[#0d1117]
text-green-400 border border-green-500 px-4 py-2 rounded-lg shadow-lg
opacity-0 transition-all duration-300 pointer-events-none tech-font">
                Copied âœ“
            </div>


            <!-- ================= SCRIPT ================= -->
            <script>

                let lastOpenedAppId = null;

                function openViewModal(id, name, desc, secret, active) {
                    lastOpenedAppId = id;

                    document.getElementById("viewModal").classList.remove("hidden");

                    document.getElementById("viewName").value = name;
                    document.getElementById("viewDesc").value = desc;
                    document.getElementById("viewSecret").value = secret;
                    document.getElementById("viewStatus").value = active ? "Active" : "Removed";

                    // fill update form hidden inputs
                    document.getElementById("upd_app_id").value = id;
                    document.getElementById("upd_appName").value = name;
                    document.getElementById("upd_description").value = desc;
                    document.getElementById("upd_secret").value = secret;
                }

                function closeViewModal() {
                    document.getElementById("viewModal").classList.add("hidden");
                    lastOpenedAppId = null;
                }

                function toggleSecretView() {
                    const f = document.getElementById("viewSecret");
                    f.type = f.type === "password" ? "text" : "password";
                }

                /* submit update form */
                function submitUpdateForm() {
                    document.getElementById("updateForm").submit();
                }

                async function openUrlTokenModal(app_id) {
                    const res = await fetch(`/dashboard/apps/url-token`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ app_id })
                    });

                    const data = await res.json();

                    document.getElementById("apiUrl").value = data?.url || "N/A";
                    document.getElementById("clientToken").value = data?.token || "N/A";

                    document.getElementById("urlTokenModal").classList.remove("hidden");
                }

                function closeUrlTokenModal() {
                    document.getElementById("urlTokenModal").classList.add("hidden");
                }

                function toggleToken() {
                    const f = document.getElementById("clientToken");
                    f.type = f.type === "password" ? "text" : "password";
                }

                function copyToClipboard(id) {
                    const value = document.getElementById(id).value;
                    navigator.clipboard.writeText(value);

                    const t = document.getElementById("copyToast");
                    t.classList.remove("opacity-0");
                    setTimeout(() => t.classList.add("opacity-0"), 1000);
                }

            </script>

    </body>

    </html>